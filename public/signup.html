<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Start Your Free Trial - SeatSnag</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  position: relative;
  overflow: hidden;
}

body::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;
  animation: gridMove 20s linear infinite;
}

@keyframes gridMove {
  0% { transform: translate(0, 0); }
  100% { transform: translate(10px, 10px); }
}

.signup-container {
  background: white;
  border-radius: 24px;
  padding: 48px;
  box-shadow: 0 32px 80px rgba(0, 0, 0, 0.3);
  max-width: 600px;
  width: 100%;
  position: relative;
  z-index: 2;
}

.signup-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 6px;
  background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
  background-size: 400% 400%;
  animation: gradientShift 8s ease infinite;
  border-radius: 24px 24px 0 0;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.signup-header {
  text-align: center;
  margin-bottom: 40px;
}

.logo {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  text-decoration: none;
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

.logo-text {
  font-size: 1.8em;
  font-weight: 800;
  color: #1e293b;
}

.signup-title {
  font-size: 2.2em;
  font-weight: 800;
  color: #1e293b;
  margin-bottom: 12px;
  letter-spacing: -0.02em;
}

.signup-subtitle {
  color: #64748b;
  font-size: 1.1em;
  line-height: 1.5;
  margin-bottom: 8px;
}

.trial-badge {
  display: inline-block;
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 999px;
  font-size: 0.85em;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 8px;
  box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
}

.signup-form {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.form-section {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 16px;
  padding: 24px;
  border: 1px solid #e2e8f0;
  position: relative;
}

.form-section::before {
  content: attr(data-title);
  position: absolute;
  top: -12px;
  left: 24px;
  background: #fff;
  padding: 0 12px;
  font-weight: 700;
  color: #1e293b;
  font-size: 0.9em;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-label {
  font-weight: 600;
  color: #374151;
  font-size: 0.95em;
}

.form-input, .form-select {
  padding: 16px 20px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 500;
  transition: all 0.3s ease;
  background: #fff;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  transform: translateY(-1px);
}

.form-input::placeholder {
  color: #9ca3af;
  font-weight: 400;
}

.pin-display {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0284c7;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  margin-top: 16px;
}

.pin-display-title {
  font-size: 0.9em;
  font-weight: 600;
  color: #0369a1;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.pin-display-value {
  font-size: 2em;
  font-weight: 800;
  color: #0c4a6e;
  font-family: 'Monaco', monospace;
  letter-spacing: 4px;
}

.features-preview {
  background: #f8fafc;
  border-radius: 16px;
  padding: 20px;
  margin: 24px 0;
}

.features-title {
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 12px;
  font-size: 0.95em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.features-list {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  font-size: 0.9em;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #64748b;
}

.feature-item::before {
  content: '‚úì';
  width: 16px;
  height: 16px;
  background: #22c55e;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  flex-shrink: 0;
}

.signup-btn {
  padding: 18px 32px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
  margin-top: 8px;
}

.signup-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
}

.signup-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.signup-footer {
  text-align: center;
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid #e5e7eb;
}

.signup-footer p {
  color: #64748b;
  font-size: 0.9em;
  margin-bottom: 8px;
}

.signup-footer a {
  color: #667eea;
  text-decoration: none;
  font-weight: 500;
}

.signup-footer a:hover {
  text-decoration: underline;
}

.loading-state {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.success-state {
  display: none;
  text-align: center;
  padding: 40px 20px;
}

.success-icon {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  margin: 0 auto 24px;
  box-shadow: 0 16px 40px rgba(34, 197, 94, 0.3);
}

.success-title {
  font-size: 1.8em;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 12px;
}

.success-message {
  color: #64748b;
  line-height: 1.6;
  margin-bottom: 24px;
}

.success-details {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0284c7;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  text-align: left;
}

.success-details-title {
  font-weight: 700;
  color: #0c4a6e;
  margin-bottom: 16px;
  font-size: 1.1em;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid rgba(2, 132, 199, 0.2);
}

.detail-item:last-child {
  border-bottom: none;
}

.detail-label {
  color: #0369a1;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.detail-value {
  color: #0c4a6e;
  font-weight: 700;
  font-family: 'Monaco', monospace;
}

.access-btn {
  padding: 16px 32px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  text-decoration: none;
  border-radius: 12px;
  font-weight: 600;
  display: inline-block;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
  margin-right: 12px;
}

.access-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

.secondary-btn {
  padding: 16px 32px;
  background: #f8fafc;
  color: #667eea;
  text-decoration: none;
  border: 2px solid #667eea;
  border-radius: 12px;
  font-weight: 600;
  display: inline-block;
  transition: all 0.3s ease;
}

.secondary-btn:hover {
  background: #667eea;
  color: white;
}

.error-feedback {
  background: #ef4444;
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: none;
  font-weight: 600;
}

@media (max-width: 768px) {
  .signup-container {
    padding: 32px 24px;
    margin: 10px;
  }
  
  .signup-title {
    font-size: 1.8em;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .features-list {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
  <div class="signup-container">
    <!-- Signup Form -->
    <div id="signupForm">
      <div class="signup-header">
        <a href="landing.html" class="logo">
          <div class="logo-icon">üöÄ</div>
          <div class="logo-text">SeatSnag</div>
        </a>
        <h1 class="signup-title">Start Your Free Trial</h1>
        <p class="signup-subtitle">Get your office seat booking system up and running in minutes.</p>
        <div class="trial-badge">14 Days Free ‚Ä¢ No Credit Card Required</div>
      </div>

      <div class="error-feedback" id="errorFeedback"></div>

      <form class="signup-form" onsubmit="handleSignup(event)">
        <!-- Company Information -->
        <div class="form-section" data-title="üè¢ Company Information">
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="form-label">Company Name</label>
              <input type="text" class="form-input" id="companyName" placeholder="Enter your company name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Company Code</label>
              <input type="text" class="form-input" id="companyCode" placeholder="e.g. TECH" maxlength="6" style="text-transform: uppercase;" required>
            </div>
            <div class="form-group">
              <label class="form-label">Team Size</label>
              <select class="form-select" id="teamSize" required>
                <option value="">Choose team size...</option>
                <option value="1-10">1-10 people</option>
                <option value="11-25">11-25 people</option>
                <option value="26-50">26-50 people</option>
                <option value="50+">50+ people</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Admin Information -->
        <div class="form-section" data-title="üë®‚Äçüíº Admin Contact">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" class="form-input" id="adminFirstName" placeholder="Your first name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-input" id="adminLastName" placeholder="Your last name" required>
            </div>
            <div class="form-group full-width">
              <label class="form-label">Email Address</label>
              <input type="email" class="form-input" id="adminEmail" placeholder="you@company.com" required>
            </div>
          </div>
          
          <!-- Auto-generated PIN Display -->
          <div class="pin-display">
            <div class="pin-display-title">Your Admin PIN</div>
            <div class="pin-display-value" id="generatedPin">----</div>
          </div>
        </div>

        <div class="features-preview">
          <div class="features-title">
            <span>‚ú®</span>
            What you'll get during your trial:
          </div>
          <div class="features-list">
            <div class="feature-item">Instant setup</div>
            <div class="feature-item">Unlimited bookings</div>
            <div class="feature-item">Real-time sync</div>
            <div class="feature-item">Usage analytics</div>
            <div class="feature-item">Email support</div>
            <div class="feature-item">No commitments</div>
          </div>
        </div>

        <button type="submit" class="signup-btn" id="submitBtn">
          <span id="btnText">Start My Free Trial</span>
          <div class="loading-state" id="loadingState">
            <div class="loading-spinner"></div>
            <span>Setting up your workspace...</span>
          </div>
        </button>
      </form>

      <div class="signup-footer">
        <p>By signing up, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></p>
        <p>Already have an account? <a href="admin.html">Access your workspace</a></p>
      </div>
    </div>

    <!-- Success State -->
    <div id="successState" class="success-state">
      <div class="success-icon">‚úì</div>
      <h2 class="success-title">Welcome to SeatSnag!</h2>
      <p class="success-message">
        Your workspace has been created successfully. You can now set up your office locations and start managing seat bookings.
      </p>
      
      <div class="success-details">
        <div class="success-details-title">üîë Your Admin Credentials</div>
        <div class="detail-item">
          <span class="detail-label">
            <span>üè¢</span>
            Company Name:
          </span>
          <span class="detail-value" id="successCompanyName">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">
            <span>üè∑Ô∏è</span>
            Company Code:
          </span>
          <span class="detail-value" id="successCompanyCode">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">
            <span>üë®‚Äçüíº</span>
            Admin Name:
          </span>
          <span class="detail-value" id="successAdminName">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">
            <span>üîë</span>
            Admin PIN:
          </span>
          <span class="detail-value" id="successPin">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">
            <span>‚è∞</span>
            Trial Expires:
          </span>
          <span class="detail-value" id="successExpiry">-</span>
        </div>
      </div>

      <div style="margin-bottom: 16px;">
        <a href="admin.html" class="access-btn">Set Up Office Locations</a>
        <a href="index.html" class="secondary-btn">Employee Portal</a>
      </div>
      
      <div class="signup-footer">
        <p><strong>Next Steps:</strong> Use your Admin PIN to log into the admin panel and create your office locations.</p>
        <p>Need help? <a href="mailto:support@seatsnag.com">Contact our support team</a></p>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      setDoc,
      doc,
      getDocs,
      query,
      where,
      serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD0aKw1vkbjN02dpTP3jGRayVqS127IObs",
      authDomain: "seatsnag-sso-dev.firebaseapp.com",
      projectId: "seatsnag-sso-dev",
      storageBucket: "seatsnag-sso-dev.firebasestorage.app",
      messagingSenderId: "138133397720",
      appId: "1:138133397720:web:9fc75b262986e1cf0677ad"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Test Firebase connection
    console.log('üî• Firebase initialized:', app);
    console.log('üóÑÔ∏è Firestore initialized:', db);

    // Generate and display PIN on page load
    document.addEventListener('DOMContentLoaded', function() {
      generateAndDisplayPin();
      setupRealTimeValidation();
      
      // Show validation tips
      console.log('üîí SeatSnag Signup - Enhanced Security Active');
      console.log('‚úÖ Email validation with typo detection');
      console.log('‚úÖ Input sanitization and profanity filtering');
      console.log('‚úÖ Rate limiting protection');
      console.log('‚úÖ Duplicate prevention across all fields');
    });

    function generatePin() {
      return Math.floor(1000 + Math.random() * 9000).toString();
    }

    function generateAndDisplayPin() {
      const pin = generatePin();
      document.getElementById('generatedPin').textContent = pin;
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorFeedback');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      
      // Auto-hide after 8 seconds
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 8000);
    }

    // Enhanced Validation Functions
    function validateEmail(email) {
      // RFC 5322 compliant email regex
      const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
      
      if (!emailRegex.test(email)) {
        return { valid: false, message: 'Please enter a valid email address' };
      }

      // Check for common typos in domains
      const commonTypos = {
        'gmial.com': 'gmail.com',
        'gmai.com': 'gmail.com',
        'yahooo.com': 'yahoo.com',
        'hotmial.com': 'hotmail.com',
        'outlok.com': 'outlook.com'
      };

      const domain = email.split('@')[1]?.toLowerCase();
      if (commonTypos[domain]) {
        return { 
          valid: false, 
          message: `Did you mean ${email.replace(domain, commonTypos[domain])}?` 
        };
      }

      // Warn about personal email domains
      const personalDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'aol.com', 'icloud.com'];
      if (personalDomains.includes(domain)) {
        return { 
          valid: true, 
          warning: 'Consider using your company email address for better organization' 
        };
      }

      return { valid: true };
    }

    function validateCompanyName(name) {
      // Length check
      if (name.length < 2) {
        return { valid: false, message: 'Company name must be at least 2 characters' };
      }
      if (name.length > 100) {
        return { valid: false, message: 'Company name must be less than 100 characters' };
      }

      // Basic profanity filter (extend this list as needed)
      const profanityList = ['test', 'fuck', 'shit', 'damn', 'fake', 'scam', 'spam'];
      const lowerName = name.toLowerCase();
      for (const word of profanityList) {
        if (lowerName.includes(word)) {
          return { valid: false, message: 'Please enter a professional company name' };
        }
      }

      // Check for suspicious patterns
      if (/^\d+$/.test(name)) {
        return { valid: false, message: 'Company name cannot be only numbers' };
      }

      if (/^[^a-zA-Z0-9\s&.-]+$/.test(name)) {
        return { valid: false, message: 'Company name contains invalid characters' };
      }

      return { valid: true };
    }

    function validateCompanyCode(code) {
      // Length check
      if (code.length < 2) {
        return { valid: false, message: 'Company code must be at least 2 characters' };
      }
      if (code.length > 6) {
        return { valid: false, message: 'Company code must be 6 characters or less' };
      }

      // Format check - alphanumeric only
      if (!/^[A-Z0-9]+$/.test(code)) {
        return { valid: false, message: 'Company code can only contain letters and numbers' };
      }

      // Reserved codes
      const reservedCodes = ['ADMIN', 'TEST', 'API', 'WWW', 'FTP', 'MAIL', 'DEMO', 'NULL', 'ROOT'];
      if (reservedCodes.includes(code)) {
        return { valid: false, message: 'This company code is reserved. Please choose another.' };
      }

      return { valid: true };
    }

    function validatePersonName(name, fieldName) {
      if (name.length < 1) {
        return { valid: false, message: `${fieldName} is required` };
      }
      if (name.length > 50) {
        return { valid: false, message: `${fieldName} must be less than 50 characters` };
      }

      // Only letters, spaces, hyphens, apostrophes
      if (!/^[a-zA-Z\s'-]+$/.test(name)) {
        return { valid: false, message: `${fieldName} can only contain letters, spaces, hyphens, and apostrophes` };
      }

      // No consecutive spaces or special chars
      if (/\s{2,}|'{2,}|-{2,}/.test(name)) {
        return { valid: false, message: `${fieldName} cannot have consecutive special characters` };
      }

      return { valid: true };
    }

    function sanitizeInput(input) {
      // Remove potential XSS and trim
      return input.trim()
        .replace(/[<>\"']/g, '')
        .replace(/\s+/g, ' ');
    }

    // Real-time validation as user types
    function setupRealTimeValidation() {
      const companyNameField = document.getElementById('companyName');
      const companyCodeField = document.getElementById('companyCode');
      const emailField = document.getElementById('adminEmail');
      const firstNameField = document.getElementById('adminFirstName');
      const lastNameField = document.getElementById('adminLastName');

      // Company name validation
      companyNameField.addEventListener('blur', function() {
        const validation = validateCompanyName(this.value.trim());
        if (!validation.valid) {
          this.style.borderColor = '#ef4444';
          showFieldError(this, validation.message);
        } else {
          this.style.borderColor = '#22c55e';
          clearFieldError(this);
        }
      });

      // Company code validation
      companyCodeField.addEventListener('blur', function() {
        const validation = validateCompanyCode(this.value.trim());
        if (!validation.valid) {
          this.style.borderColor = '#ef4444';
          showFieldError(this, validation.message);
        } else {
          this.style.borderColor = '#22c55e';
          clearFieldError(this);
        }
      });

      // Email validation
      emailField.addEventListener('blur', function() {
        const validation = validateEmail(this.value.trim());
        if (!validation.valid) {
          this.style.borderColor = '#ef4444';
          showFieldError(this, validation.message);
        } else if (validation.warning) {
          this.style.borderColor = '#f59e0b';
          showFieldWarning(this, validation.warning);
        } else {
          this.style.borderColor = '#22c55e';
          clearFieldError(this);
        }
      });

      // Name validations
      firstNameField.addEventListener('blur', function() {
        const validation = validatePersonName(this.value.trim(), 'First name');
        if (!validation.valid) {
          this.style.borderColor = '#ef4444';
          showFieldError(this, validation.message);
        } else {
          this.style.borderColor = '#22c55e';
          clearFieldError(this);
        }
      });

      lastNameField.addEventListener('blur', function() {
        const validation = validatePersonName(this.value.trim(), 'Last name');
        if (!validation.valid) {
          this.style.borderColor = '#ef4444';
          showFieldError(this, validation.message);
        } else {
          this.style.borderColor = '#22c55e';
          clearFieldError(this);
        }
      });
    }

    function showFieldError(field, message) {
      clearFieldError(field);
      const error = document.createElement('div');
      error.className = 'field-error';
      error.style.cssText = 'color: #ef4444; font-size: 0.85em; margin-top: 4px; font-weight: 500;';
      error.textContent = message;
      field.parentNode.appendChild(error);
    }

    function showFieldWarning(field, message) {
      clearFieldError(field);
      const warning = document.createElement('div');
      warning.className = 'field-warning';
      warning.style.cssText = 'color: #f59e0b; font-size: 0.85em; margin-top: 4px; font-weight: 500;';
      warning.textContent = message;
      field.parentNode.appendChild(warning);
    }

    function clearFieldError(field) {
      const existing = field.parentNode.querySelector('.field-error, .field-warning');
      if (existing) {
        existing.remove();
      }
    }

    // Rate limiting for signup attempts
    function checkRateLimit() {
      const now = Date.now();
      const lastAttempt = localStorage.getItem('lastSignupAttempt');
      const attempts = parseInt(localStorage.getItem('signupAttempts') || '0');
      const rateLimitWindow = 5 * 60 * 1000; // 5 minutes
      const maxAttempts = 3;

      if (lastAttempt && (now - parseInt(lastAttempt)) < rateLimitWindow) {
        if (attempts >= maxAttempts) {
          const timeLeft = Math.ceil((rateLimitWindow - (now - parseInt(lastAttempt))) / 60000);
          throw new Error(`Too many signup attempts. Please try again in ${timeLeft} minutes.`);
        }
      } else {
        // Reset counter if window has passed
        localStorage.setItem('signupAttempts', '0');
      }
    }

    function recordSignupAttempt() {
      const attempts = parseInt(localStorage.getItem('signupAttempts') || '0') + 1;
      localStorage.setItem('signupAttempts', attempts.toString());
      localStorage.setItem('lastSignupAttempt', Date.now().toString());
    }

    async function createUnverifiedCompany(companyData) {
  try {
            console.log('Creating unverified company with data:', companyData);

            // Generate verification token
            const verificationToken = Math.random().toString(36).substring(2, 15) + 
                                    Math.random().toString(36).substring(2, 15);

            // Create company record (UNVERIFIED)
            const companyRef = await addDoc(collection(db, 'companies'), {
              name: companyData.name,
              companyCode: companyData.code.toUpperCase(),
              adminFirstName: companyData.firstName,
              adminLastName: companyData.lastName,
              adminEmail: companyData.email,
              secretPin: companyData.pin,
              emailVerified: false,              // NEW: Not verified yet
              verificationToken: verificationToken, // NEW: For email verification
              trialStatus: 'pending',            // NEW: Trial hasn't started
              trialStartDate: null,              // NEW: Will be set on verification
              trialEndDate: null,                // NEW: Will be set on verification
              isActive: false,                   // NEW: Not active until verified
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });

            console.log('Unverified company created with ID:', companyRef.id);
            return { companyId: companyRef.id, verificationToken };

          } catch (error) {
            console.error('Error creating unverified company:', error);
            throw error;
          }
        }

    async function sendVerificationEmail(companyData, verificationToken) {
            try {
              console.log('Sending verification email to:', companyData.email);

              const verificationUrl = `https://seatsnag-sso-dev.web.app/verify?token=${verificationToken}&company=${companyData.companyId}`;

              await addDoc(collection(db, 'mail'), {
                to: [companyData.email],
                message: {
                  subject: 'Verify your SeatSnag account - Activate your trial',
                  html: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                      <h1 style="color: #667eea;">Almost there, ${companyData.firstName}!</h1>
                      <p>Thanks for signing up for SeatSnag. To activate your 14-day free trial, please verify your email address.</p>
                      
                      <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h3>Company: ${companyData.name}</h3>
                        <p>Admin: ${companyData.firstName} ${companyData.lastName}</p>
                      </div>
                      
                      <a href="${verificationUrl}" 
                        style="background: #667eea; color: white; padding: 16px 32px; 
                                text-decoration: none; border-radius: 8px; display: inline-block;
                                font-weight: 600; margin: 20px 0;">
                        Verify Email & Start Trial ‚Üí
                      </a>
                      
                      <p style="margin-top: 30px; color: #666; font-size: 14px;">
                        If the button doesn't work, copy and paste this link:<br>
                        <a href="${verificationUrl}">${verificationUrl}</a>
                      </p>
                      
                      <p style="margin-top: 20px; color: #666; font-size: 14px;">
                        This link will expire in 24 hours. If you didn't sign up for SeatSnag, you can ignore this email.
                      </p>
                    </div>
                  `
                }
              });

              console.log('Verification email queued successfully');
            } catch (error) {
              console.error('Error sending verification email:', error);
              throw error;
            }
          }      


        
    async function checkDuplicates(name, code, pin, email) {
      try {
        console.log('üîç Checking for duplicates...');

        // Check for duplicate company names
        const nameQuery = query(
          collection(db, 'companies'),
          where('name', '==', name)
        );
        const nameSnapshot = await getDocs(nameQuery);
        if (!nameSnapshot.empty) {
          throw new Error('A company with this name already exists');
        }

        // Check for duplicate company codes
        const codeQuery = query(
          collection(db, 'companies'),
          where('companyCode', '==', code)
        );
        const codeSnapshot = await getDocs(codeQuery);
        if (!codeSnapshot.empty) {
          throw new Error('A company with this code already exists. Please choose a different code.');
        }

        // Check for duplicate email addresses
        const emailQuery = query(
          collection(db, 'companies'),
          where('adminEmail', '==', email)
        );
        const emailSnapshot = await getDocs(emailQuery);
        if (!emailSnapshot.empty) {
          throw new Error('An account with this email address already exists');
        }

        // Check for duplicate PINs
        const pinQuery = query(
          collection(db, 'companies'),
          where('secretPin', '==', pin)
        );
        const pinSnapshot = await getDocs(pinQuery);
        if (!pinSnapshot.empty) {
          throw new Error('This PIN is already in use. Please refresh to generate a new one.');
        }

        console.log('‚úÖ No duplicates found');

      } catch (error) {
        throw error;
      }
    }

    // Test Firebase connection function
    window.testFirebase = async function() {
      try {
        console.log('üß™ Testing Firebase connection...');
        const testRef = await addDoc(collection(db, 'test'), {
          message: 'Hello from signup page',
          timestamp: serverTimestamp()
        });
        console.log('‚úÖ Test write successful:', testRef.id);
        alert('Firebase connection works!');
      } catch (error) {
        console.error('‚ùå Firebase test failed:', error);
        alert('Firebase error: ' + error.message);
      }
    };

    window.handleSignup = async function(event) {
      event.preventDefault();
      
      try {
        console.log('üöÄ Starting signup process...');
        
        // Rate limiting check
        checkRateLimit();

        // Get and sanitize form data
        const companyName = sanitizeInput(document.getElementById('companyName').value);
        const companyCode = sanitizeInput(document.getElementById('companyCode').value.toUpperCase());
        const teamSize = document.getElementById('teamSize').value;
        const firstName = sanitizeInput(document.getElementById('adminFirstName').value);
        const lastName = sanitizeInput(document.getElementById('adminLastName').value);
        const email = sanitizeInput(document.getElementById('adminEmail').value.toLowerCase());
        const pin = document.getElementById('generatedPin').textContent;

        console.log('üìù Form data collected:', { companyName, companyCode, teamSize, firstName, lastName, email, pin });

        // Comprehensive validation
        const companyNameValidation = validateCompanyName(companyName);
        if (!companyNameValidation.valid) {
          throw new Error(companyNameValidation.message);
        }

        const companyCodeValidation = validateCompanyCode(companyCode);
        if (!companyCodeValidation.valid) {
          throw new Error(companyCodeValidation.message);
        }

        const emailValidation = validateEmail(email);
        if (!emailValidation.valid) {
          throw new Error(emailValidation.message);
        }

        const firstNameValidation = validatePersonName(firstName, 'First name');
        if (!firstNameValidation.valid) {
          throw new Error(firstNameValidation.message);
        }

        const lastNameValidation = validatePersonName(lastName, 'Last name');
        if (!lastNameValidation.valid) {
          throw new Error(lastNameValidation.message);
        }

        if (!teamSize) {
          throw new Error('Please select your team size');
        }

        console.log('‚úÖ All validations passed');

        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const loadingState = document.getElementById('loadingState');
        
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        loadingState.style.display = 'flex';

        // Check for duplicates (enhanced with email check)
        await checkDuplicates(companyName, companyCode, pin, email);

        // Create company with trial
        const result = await createUnverifiedCompany({
          name: companyName,
          code: companyCode,
          firstName: firstName,
          lastName: lastName,
          email: email,
          pin: pin,
          teamSize: teamSize
        });

        // Send verification email
        await sendVerificationEmail({
          companyId: result.companyId,
          name: companyName,
          firstName: firstName,
          lastName: lastName,
          email: email
        }, result.verificationToken);
        // Record successful signup
        localStorage.removeItem('signupAttempts');
        localStorage.removeItem('lastSignupAttempt');

        console.log('üéâ Signup completed successfully!');

        // Show success state
        // Show verification success state
        showVerificationSuccessState({
          companyName: companyName,
          email: email
        });

      } catch (error) {
        console.error('‚ùå Signup error:', error);
        recordSignupAttempt();
        
        showError(error.message || 'Failed to create your account. Please try again.');
        
        // Reset button state
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const loadingState = document.getElementById('loadingState');
        
        submitBtn.disabled = false;
        btnText.style.display = 'block';
        loadingState.style.display = 'none';
      }
    };

   function showVerificationSuccessState(data) {
          document.getElementById('signupForm').style.display = 'none';
          document.getElementById('successState').style.display = 'block';
          
          // Update the success message for verification flow
          document.getElementById('successState').innerHTML = `
            <div class="success-icon">üìß</div>
            <h2 class="success-title">Check Your Email!</h2>
            <p class="success-message">
              We've sent a verification email to <strong>${data.email}</strong>. 
              Click the verification link to activate your 14-day free trial.
            </p>
            
            <div class="success-details">
              <div class="success-details-title">üè¢ What's Next?</div>
              <div class="detail-item">
                <span class="detail-label">
                  <span>‚úâÔ∏è</span>
                  Check your email:
                </span>
                <span class="detail-value">${data.email}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">
                  <span>üîó</span>
                  Click the verification link
                </span>
                <span class="detail-value">Activate Trial</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">
                  <span>‚è∞</span>
                  Link expires in:
                </span>
                <span class="detail-value">24 hours</span>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <p style="color: #64748b; margin: 16px 0;">
                Can't find the email? Check your spam folder or 
                <a href="#" onclick="location.reload()" style="color: #667eea;">try signing up again</a>.
              </p>
            </div>
            
            <div class="signup-footer">
              <p>Need help? <a href="mailto:emma@seatsnag.io">Contact our support team</a></p>
            </div>
          `;
        }
    // Auto-generate new PIN when company code changes (to avoid conflicts)
    document.getElementById('companyCode').addEventListener('input', function() {
      generateAndDisplayPin();
    });

    // Auto-generate company code from company name
    document.getElementById('companyName').addEventListener('input', function() {
      const name = this.value.trim();
      const codeField = document.getElementById('companyCode');
      
      if (name && !codeField.value) {
        // Generate code from company name (first 4-6 chars, uppercase, alphanumeric only)
        let code = name.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().substring(0, 6);
        if (code.length < 2) {
          code = name.substring(0, 4).toUpperCase().replace(/[^A-Z]/g, '');
        }
        codeField.value = code;
      }
    });

  </script>
</body>
</html>